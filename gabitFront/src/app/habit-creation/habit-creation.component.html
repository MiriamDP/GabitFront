<div class="habit-creation-container">
  <div class="creation-header">
    <div class="header-content">
      <h1 class="page-title">Crear nuevo hábito</h1>
      <button class="btn-cancel" (click)="cancelCreation()">Cancelar</button>
    </div>
    <div class="progress-indicator">
      <div class="progress-steps">
        <div *ngFor="let step of [1, 2, 3, 4]" class="progress-step" [class.active]="currentStep === step" [class.completed]="currentStep > step" (click)="goToStep(step)">
          <div class="step-circle">
            <span *ngIf="currentStep <= step">{{ step }}</span>
            <lucide-icon *ngIf="currentStep > step" name="check" class="check-icon" [size]="20"></lucide-icon>
          </div>
          <span class="step-label">
            <ng-container [ngSwitch]="step">
              <span *ngSwitchCase="1">Información</span>
              <span *ngSwitchCase="2">Niveles</span>
              <span *ngSwitchCase="3">Misiones</span>
              <span *ngSwitchCase="4">Logros</span>
            </ng-container>
          </span>
        </div>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="(currentStep / totalSteps) * 100"></div>
      </div>
    </div>
  </div>

  <form [formGroup]="habitForm" class="creation-form">
    <div class="form-step" *ngIf="currentStep === 1" [@fadeIn]>
      <div class="step-content" formGroupName="basicInfo">
        <h2 class="step-title">Información básica del hábito</h2>
        <p class="step-description">Define las características principales de tu nuevo hábito</p>
        
        <div class="form-group">
          <label for="habitName" class="form-label">Nombre del hábito <span class="required">*</span></label>
          <input id="habitName" type="text" formControlName="name" class="form-input" placeholder="Ej: Leer 30 minutos diarios" maxlength="50">
          <div class="form-error" *ngIf="basicInfo.get('name')?.invalid && basicInfo.get('name')?.touched">El nombre debe tener al menos 3 caracteres</div>
        </div>

        <div class="form-group">
          <label for="habitDescription" class="form-label">Descripción <span class="required">*</span></label>
          <textarea id="habitDescription" formControlName="description" class="form-textarea" placeholder="Describe tu hábito y por qué es importante para ti..." rows="4" maxlength="200"></textarea>
          <div class="form-error" *ngIf="basicInfo.get('description')?.invalid && basicInfo.get('description')?.touched">La descripción debe tener al menos 10 caracteres</div>
        </div>

        <div class="form-group">
          <label for="habitCategory" class="form-label">Categoría <span class="required">*</span></label>
          <div *ngIf="isLoading" class="loading-message">Cargando categorías...</div>
          
          <div *ngIf="!isLoading" class="category-grid">
            <div *ngFor="let category of categories" class="category-card" [class.selected]="basicInfo.get('category')?.value === category.id" (click)="basicInfo.patchValue({ category: category.id })">
              <lucide-icon [name]="category.icono" class="category-icon" [size]="28"></lucide-icon>
              <span class="category-name">{{ category.nombre }}</span>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Color del hábito <span class="required">*</span></label>
          <p class="form-hint">Elige un color que represente tu hábito</p>
          <div class="color-picker">
            <div *ngFor="let color of availableColors" class="color-option" [class.selected]="basicInfo.get('color')?.value === color" [style.background-color]="color" (click)="selectColor(color)">
              <lucide-icon *ngIf="basicInfo.get('color')?.value === color" name="check" class="color-check" [size]="20"></lucide-icon>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" formControlName="isPublic" class="form-checkbox">
            <span class="checkbox-text"><strong>Hacer público</strong> - Otros usuarios podrán ver y usar este hábito</span>
          </label>
        </div>
      </div>
    </div>

    <div class="form-step" *ngIf="currentStep === 2" [@fadeIn]>
      <div class="step-content" formGroupName="levels">
        <h2 class="step-title">Configura los niveles</h2>
        <p class="step-description">Define cuántos niveles tendrá tu hábito y cuántos puntos se necesitan para cada uno</p>
        
        <div class="form-group">
          <label for="levelCount" class="form-label">Número de niveles <span class="required">*</span></label>
          <div class="slider-container">
            <input id="levelCount" type="range" min="1" max="10" formControlName="numberOfLevels" (input)="onLevelCountChange($event)" class="form-slider">
            <div class="slider-value">{{ levelsGroup.get('numberOfLevels')?.value }} niveles</div>
          </div>
        </div>

        <div class="levels-configuration" formArrayName="levelDetails">
          <div *ngFor="let level of levelDetails.controls; let i = index" class="level-card" [formGroupName]="i">
            <div class="level-header"><span class="level-number">Nivel {{ i + 1 }}</span></div>
            <div class="level-body">
              <div class="form-group-inline">
                <div class="form-group flex-1">
                  <label [for]="'levelName' + i" class="form-label-sm">Nombre del nivel</label>
                  <input [id]="'levelName' + i" type="text" formControlName="name" class="form-input-sm" placeholder="Ej: Principiante">
                </div>
                <div class="form-group flex-1">
                  <label [for]="'levelPoints' + i" class="form-label-sm">Puntos requeridos</label>
                  <input [id]="'levelPoints' + i" type="number" formControlName="pointsRequired" class="form-input-sm" min="1" placeholder="100">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="form-step" *ngIf="currentStep === 3" [@fadeIn]>
      <div class="step-content">
        <h2 class="step-title">Crea las misiones</h2>
        <p class="step-description">Define las tareas que los usuarios completarán en cada nivel</p>
        
        <div class="missions-container" formArrayName="missions">
          <div *ngFor="let level of levelDetails.controls; let levelIndex = index" class="mission-level-section">
            <div class="mission-level-header">
              <h3 class="mission-level-title">{{ level.get('name')?.value }} - Nivel {{ levelIndex + 1 }}</h3>
              <button type="button" class="btn-add-small" (click)="addMission(levelIndex)">+ Añadir misión</button>
            </div>
            
            <div *ngIf="getMissionsForLevel(levelIndex).length === 0" class="empty-missions">
              <p>No hay misiones para este nivel. Añade al menos una misión.</p>
            </div>

            <div [formArrayName]="levelIndex" class="missions-list">
              <div *ngFor="let mission of getMissionsForLevel(levelIndex).controls; let missionIndex = index" class="mission-card" [formGroupName]="missionIndex">
                <div class="mission-header">
                  <span class="mission-number">Misión {{ missionIndex + 1 }}</span>
                  <button type="button" class="btn-remove-icon" (click)="removeMission(levelIndex, missionIndex)" title="Eliminar misión">
                    <lucide-icon name="x" [size]="18"></lucide-icon>
                  </button>
                </div>
                <div class="mission-body">
                  <div class="form-group">
                    <label [for]="'missionDesc' + levelIndex + missionIndex" class="form-label-sm">Descripción de la misión</label>
                    <input [id]="'missionDesc' + levelIndex + missionIndex" type="text" formControlName="description" class="form-input-sm" placeholder="Ej: Completar 3 sesiones esta semana">
                  </div>
                  <div class="form-group-inline">
                    <div class="form-group flex-1">
                      <label [for]="'missionPoints' + levelIndex + missionIndex" class="form-label-sm">Puntos</label>
                      <input [id]="'missionPoints' + levelIndex + missionIndex" type="number" formControlName="points" class="form-input-sm" min="1" placeholder="10">
                    </div>
                    <div class="form-group flex-1">
                      <label [for]="'missionType' + levelIndex + missionIndex" class="form-label-sm">Tipo</label>
                      <select [id]="'missionType' + levelIndex + missionIndex" formControlName="type" class="form-select-sm">
                        <option *ngFor="let type of missionTypes" [value]="type.value">{{ type.label }}</option>
                      </select>
                    </div>
                    <div class="form-group flex-1">
                      <label [for]="'missionReq' + levelIndex + missionIndex" class="form-label-sm">Cantidad</label>
                      <input [id]="'missionReq' + levelIndex + missionIndex" type="number" formControlName="requirement" class="form-input-sm" min="1" placeholder="1">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="form-step" *ngIf="currentStep === 4" [@fadeIn]>
      <div class="step-content">
        <h2 class="step-title">Logros especiales (opcional)</h2>
        <p class="step-description">Crea hitos importantes que den recompensas extra</p>
        
        <button type="button" class="btn-add" (click)="addAchievement()">+ Añadir logro</button>
        
        <div *ngIf="achievements.length === 0" class="empty-state">
          <p>No has añadido ningún logro todavía. Los logros son opcionales pero hacen el hábito más motivador.</p>
        </div>

        <div formArrayName="achievements" class="achievements-list">
          <div *ngFor="let achievement of achievements.controls; let i = index" class="achievement-card" [formGroupName]="i">
            <div class="achievement-header">
              <span class="achievement-icon-display">
                <lucide-icon [name]="achievement.get('icon')?.value || 'trophy'" [size]="48"></lucide-icon>
              </span>
              <button type="button" class="btn-remove-icon" (click)="removeAchievement(i)" title="Eliminar logro">
                <lucide-icon name="x" [size]="18"></lucide-icon>
              </button>
            </div>
            <div class="achievement-body">
              <div class="form-group">
                <label [for]="'achievementName' + i" class="form-label-sm">Nombre del logro</label>
                <input [id]="'achievementName' + i" type="text" formControlName="name" class="form-input-sm" placeholder="Ej: Racha de 30 días">
              </div>
              <div class="form-group">
                <label [for]="'achievementDesc' + i" class="form-label-sm">Descripción</label>
                <textarea [id]="'achievementDesc' + i" formControlName="description" class="form-textarea-sm" rows="2" placeholder="Describe qué significa conseguir este logro..."></textarea>
              </div>
              <div class="form-group-inline">
                <div class="form-group flex-1">
                  <label [for]="'achievementIcon' + i" class="form-label-sm">Nombre Icono (Lucide)</label>
                  <input [id]="'achievementIcon' + i" type="text" formControlName="icon" class="form-input-sm" placeholder="Ej: trophy, star, zap">
                </div>
                <div class="form-group flex-1">
                  <label [for]="'achievementPoints' + i" class="form-label-sm">Puntos de recompensa</label>
                  <input [id]="'achievementPoints' + i" type="number" formControlName="pointsReward" class="form-input-sm" min="1" placeholder="50">
                </div>
              </div>
              <div class="form-group">
                <label [for]="'achievementReq' + i" class="form-label-sm">Requisito para obtenerlo</label>
                <input [id]="'achievementReq' + i" type="text" formControlName="requirement" class="form-input-sm" placeholder="Ej: Completar el hábito 30 días seguidos">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button type="button" class="btn-secondary" *ngIf="currentStep > 1" (click)="previousStep()" [disabled]="isSubmitting">← Anterior</button>
      <div class="spacer"></div>
      <button type="button" class="btn-primary" *ngIf="currentStep < totalSteps" (click)="nextStep()" [disabled]="!isCurrentStepValid() || isSubmitting">Siguiente →</button>
      
      <button type="button" class="btn-success" *ngIf="currentStep === totalSteps" (click)="onSubmit()" [disabled]="!habitForm.valid || isSubmitting">
        <span *ngIf="!isSubmitting" style="display: flex; align-items: center; gap: 8px;">
          <lucide-icon name="check" [size]="18"></lucide-icon> Crear hábito
        </span>
        <span *ngIf="isSubmitting">⏳ Guardando...</span>
      </button>
    </div>
  </form>
</div>